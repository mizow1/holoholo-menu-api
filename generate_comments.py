import pandas as pd
import sys
import random
from datetime import datetime, timedelta

sys.stdout.reconfigure(encoding='utf-8')

# Excelファイル読み込み
df = pd.read_excel('ホロホロタロット追加メニュー.xlsx')
df_contents = df[df['contents_id'].notna()].copy()
df_contents = df_contents[['contents_id', 'name', 'caption', 'category']].copy()
df_contents = df_contents.drop_duplicates(subset=['contents_id'])
df_contents = df_contents[df_contents['contents_id'].apply(lambda x: isinstance(x, (int, float)) and x > 0)]

# カテゴリー別のコメント生成関数
def generate_comment(category):
    """カテゴリーに応じた自然なコメントを生成"""

    # 恋愛系（1,2,3,9） - 大幅に増量
    love_comments = [
        'この鑑定、すごく当たってる気がする。彼の気持ちが少し分かった気がします。',
        'モヤモヤしてた気持ちが整理できました。前向きに考えられそう。',
        'あの人のこと、もう少し信じてみようと思います。',
        '不安で押しつぶされそうだったけど、少し楽になれました。',
        '背中を押してもらえた感じ。勇気出してアプローチしてみようかな。',
        '彼の態度の理由が分かってスッキリした。もう少し様子見てみます。',
        'ハワイアンタロット初めてだったけど、すごく心に響きました。',
        '占い結果を信じて、もう少しだけ頑張ってみます！',
        'こんなに詳しく教えてもらえると思わなかった。参考にします。',
        '当たってる部分が多くてびっくり。これからどうすればいいか見えてきた。',
        '友達には相談できない内容だったので、占ってもらえてよかったです。',
        '彼の本音が知れて良かった。焦らずゆっくり関係を深めていきたい。',
        'めちゃくちゃ当たってて怖いくらい...でも安心できました。',
        '諦めかけてたけど、もう少しだけ希望を持ってもいいかな。',
        'アドバイス通りにやってみます。良い方向に進むといいな。',
        '自分の気持ちに整理がついた。ありがとうございます。',
        'カードの意味が深くて、何度も読み返してしまいました。',
        '今の状況にピッタリで驚いた。信じて待ってみようと思います。',
        '復縁できるかも...って少し希望が見えてきました。',
        'この人で良かったのか迷ってたけど、答えが出た気がします。',
        '彼のことで悩んでたんですが、少し気持ちが楽になりました。',
        '恋愛運上がりますように。前向きに頑張ります！',
        '片思いで辛かったけど、希望が見えた。',
        'もう一度やり直せるかも...勇気が出ました。',
        '二人の未来が楽しみになってきた。',
        '結婚できる日が来るといいな...頑張ろう。',
        '相性が良いって分かって嬉しい。',
        '恋の悩みが少し軽くなりました。',
        '好きな人の気持ちが知りたくて占いました。少し安心できた。',
        '彼との今後が見えてきて良かったです。',
        'LINEの返信が遅くて不安だったけど、彼なりの理由があるんだと分かった。',
        '告白するタイミング、これで迷わなくて済みそう。',
        '彼が私のことをどう思ってるのか知れて嬉しかったです。',
        '運命の人かもって思ってたけど、確信に変わりました。',
        '遠距離恋愛で不安だったけど、少し前向きになれた。',
        '元カレのことまだ引きずってたけど、やっと前に進めそう。',
        '年下の彼との恋に悩んでたけど、年齢は関係ないって思えた。',
        'バツイチだけど再婚できるって言われて嬉しい。',
        '略奪愛になっちゃうけど...でもこの恋、諦めたくない。',
        '社内恋愛でバレるのが怖かったけど、うまくやっていけそう。',
        '彼の元カノと比較して落ち込んでたけど、自信持てた。',
        '結婚の話が出たときの彼の反応、これで理解できました。',
        '同棲するか迷ってたけど、決断できそうです。',
        '婚活疲れしてたけど、もう少し頑張れそう。',
        'マッチングアプリで出会った人だけど、真剣交際に進めそう。',
        '既婚者だけど離婚して私のところに来るって信じていいのかな...少し希望が持てた。',
        '年の差があるけど、お互い本気なら大丈夫って背中押された。',
        'プロポーズ待ちで不安だったけど、もうすぐかも。',
        '彼のご両親に会うの緊張してたけど、アドバイスもらえて良かった。',
        'デートの誘い方、参考にさせてもらいます。',
        '連絡頻度について悩んでたけど、解決策が見つかった。',
        '彼の浮気疑惑...占ってみて少し安心できた。',
        'ケンカ中だったけど、仲直りのヒントをもらえました。',
        'マンネリ化してた関係に、新しい風を吹き込めそう。',
        '倦怠期かと思ってたけど、まだ愛されてるって分かって安心。',
        '彼の転勤についていくか悩んでたけど、答えが出た気がする。',
        '遊びか本気か見極められなかったけど、彼の真意が分かった。',
        '友達以上恋人未満の関係から、一歩進めそう。',
        '元彼から連絡が来て動揺してたけど、どうすべきか分かった。',
        '三角関係で苦しんでたけど、自分の気持ちに正直になれそう。',
    ]

    # 仕事系（8） - 大幅に増量
    work_comments = [
        '仕事のモヤモヤが晴れた気がします。頑張ろう。',
        '転職するか迷ってたけど、決断できそうです。',
        '職場の人間関係で悩んでたので、アドバイスが参考になりました。',
        'キャリアの方向性が見えてきた。実践してみます。',
        '上司との関係で悩んでたけど、少し気が楽になりました。',
        '今の仕事で良かったんだと安心できた。',
        '将来のキャリアについて考えるいいきっかけになりました。',
        '自分の強みが分かって自信が持てそうです。',
        '仕事運アップのヒントをもらえて嬉しい！',
        '転職のタイミング、参考にさせていただきます。',
        '職場での評価が気になってたので占ってみました。励まされました。',
        '仕事で行き詰まってたけど、突破口が見えた気がする。',
        'キャリアチェンジ、前向きに検討してみます。',
        '自分に合った仕事が分かって良かったです。',
        '職場の同僚との関係改善のヒントをもらえた。',
        '昇進試験の前で不安だったけど、自信が持てた。',
        '部署異動の希望出すか迷ってたけど、背中押された。',
        '起業するか悩んでたけど、今じゃないって分かった。',
        'フリーランスになる勇気をもらえました。',
        '副業始めるタイミング、これで迷わない。',
        'パワハラで悩んでたけど、対処法が見えてきた。',
        '同期との競争に疲れてたけど、自分のペースでいいんだと思えた。',
        '営業成績が伸び悩んでたけど、アドバイス実践してみます。',
        'プロジェクトリーダーになる自信がなかったけど、頑張れそう。',
        '転勤の打診があって悩んでたけど、決断できた。',
        '資格試験に挑戦するか迷ってたけど、やってみる。',
        '会社を辞めるべきか続けるべきか、答えが出ました。',
        'スキルアップの方向性が見えてきた。',
        '職場の派閥争いに巻き込まれて疲れてたけど、距離の取り方が分かった。',
        '残業続きで体調崩しそうだったけど、転職を真剣に考えてみる。',
        '新人教育を任されて不安だったけど、大丈夫そう。',
        'リモートワークと出社のバランスで悩んでたけど、解決策が見つかった。',
        '独立するなら今だって背中を押してもらえた。',
        '今の会社であと何年働くべきか、目安が分かりました。',
        '海外勤務の話があって迷ってたけど、決められそう。',
    ]

    # 金運系（7）と人間関係系 - 大幅に増量
    money_relationship_comments = [
        '金運アップのために早速実践してみます！',
        'お金の使い方、見直してみようと思いました。',
        '臨時収入期待しちゃう。でもまずは地道に頑張ります。',
        '経済的な不安が少し和らぎました。',
        '投資のタイミング、参考になりました。',
        '無駄遣いを見直すきっかけになった。',
        '金運の流れが分かって良かったです。',
        'お金に対する考え方が変わりそう。',
        '人間関係で悩んでたので助かりました。',
        '苦手な人との付き合い方のヒントをもらえた。',
        '周りとの関係を見直すいいきっかけになりました。',
        '友人関係のモヤモヤが少し晴れた気がします。',
        '人付き合いのコツが分かった気がする。',
        '対人運が上がりますように...頑張ります。',
        '人間関係のストレスが軽くなりそうです。',
        '家族との関係で悩んでたので、アドバイス参考になりました。',
        '人生の目的が少し見えてきた気がします。',
        '自分らしく生きていいんだと思えた。',
        '新しい出会いに期待が持てそう。',
        '豊かさを引き寄せられる気がしてきました。',
        '貯金が全然できなくて悩んでたけど、アドバイス実践します。',
        '借金返済の目処が立ちそう。頑張ります。',
        '副収入を得る方法、参考にさせてもらいます。',
        'ボーナスの使い道、これで迷わない。',
        '株式投資始めるか迷ってたけど、慎重に検討してみる。',
        '不動産投資のタイミング、見極められそう。',
        '老後資金の不安が少し和らぎました。',
        'クレジットカードの使いすぎを反省。見直します。',
        '親戚との金銭トラブル、解決の糸口が見えた。',
        '保険の見直しタイミング、これで判断できそう。',
        'ママ友との関係で疲れてたけど、距離感が分かった。',
        '義理の両親との同居で悩んでたけど、少し気が楽になった。',
        '親友だと思ってた人に裏切られて...でも前向きになれそう。',
        '隣人トラブルで困ってたけど、対処法のヒントをもらえた。',
        'SNSでの人間関係疲れ。少し距離を置いてみます。',
        '学生時代の友人との再会、どうすべきか分かりました。',
        '両親との関係を見直すいいきっかけになった。',
        '兄弟姉妹との確執、和解のヒントをもらえました。',
        '子育ての悩み、少し軽くなった気がします。',
        '親の介護問題で悩んでたけど、心の整理がついた。',
        '離れて暮らす家族のこと、もっと大切にしようと思った。',
        '天職が何か分かった気がする。転職も視野に。',
        '自分の才能に気づけて嬉しい。',
        '使命感を持って生きられそう。',
        '健康運が気になってたけど、アドバイスもらえた。',
        '心の癒しが必要だったんだと気づけました。',
        '総合運勢を見て、今年の過ごし方が見えてきた。',
        '人生の転機が近いって分かって、心の準備ができた。',
        'スピリチュアルな意味での成長を感じられそう。',
    ]

    # 共通コメント（長め） - 大幅に増量
    general_long_comments = [
        'カードの絵がかわいくて癒される。内容も良かったです。',
        'ハワイアンタロット、雰囲気が好きです。また占ってもらいたい。',
        '占い結果を励みに頑張ります。ありがとうございました。',
        '思ってた以上に詳しく見てもらえて満足です。',
        '今の自分に必要なメッセージだった気がします。',
        '定期的に占ってもらおうと思います。リピ確定！',
        '友達にも勧めたい！すごく良かったです。',
        '当たってるところが多くて驚きました。信じます。',
        '前向きになれる内容で良かったです。元気出ました。',
        '具体的なアドバイスが嬉しかったです。実践します。',
        'スッキリしました。ありがとうございます。また利用します。',
        '心が軽くなった。占ってもらって良かった。',
        'なるほど...って納得できる部分が多かったです。',
        '一人で悩んでたので、占ってもらえて助かりました。',
        '鑑定結果、保存して何度も見返そうと思います。',
        '迷いが吹っ切れました。決断できそうです。',
        '将来への不安が少し和らぎました。',
        '自分を信じていいんだと思えた。ありがとう。',
        'ポジティブな気持ちになれました。',
        '悩んでたことの答えが見つかった気がします。',
        'ハワイの神様のパワーを感じます。頑張れそう。',
        'タロットカードの意味を詳しく教えてもらえて勉強になりました。',
        '漠然とした不安が具体的になって、対策が見えてきた。',
        '今まで気づかなかった視点をもらえました。',
        '自分では考えつかなかったアドバイスで目からウロコ。',
        'モヤモヤしてた気持ちが整理できて良かったです。',
        '誰にも相談できなかったことだったので、占ってもらえて救われました。',
        'カードのメッセージが心に刺さりました。大切にします。',
        '優しい鑑定内容で癒されました。ありがとうございます。',
        'こんなに当たる占いは初めてです。びっくりしました。',
        '鑑定結果をスクショして、時々見返そうと思います。',
        '占いを信じてなかったけど、これは当たってると思う。',
        'ネガティブな結果じゃなくて良かった。前向きに頑張ります。',
        'アロハの精神を感じる温かい鑑定でした。',
        'ハワイの波動を感じられる素敵な占いですね。',
        'カードの絵柄が南国っぽくて見てるだけで元気出ます。',
        '普通のタロットと違って、ポジティブなメッセージが多くて好き。',
        '鑑定料金以上の価値がありました。満足です。',
        '迷ってたことの答えが明確になって助かりました。',
        '占いって当たるんだなって実感しました。',
        '今の自分の状況とリンクしてて鳥肌が立ちました。',
        'アドバイスが具体的で分かりやすかったです。',
        '背中を押してほしかったので、ちょうど良かった。',
        '厳しいことも優しく伝えてくれる感じが好きです。',
        '自分の直感が間違ってなかったって確信できた。',
        'カードが選んでくれたメッセージ、大切にします。',
        '運命を信じてみようと思えるようになりました。',
        '不思議と心が落ち着きました。ありがとうございます。',
        '今まで見えてなかったことが見えてきた気がします。',
        'タイミング的に今これを知れて本当に良かった。',
    ]

    # 共通コメント（短め） - 大幅に増量
    general_short_comments = [
        '当たってるかも。',
        'すごく参考になりました。',
        '良い結果で嬉しい！',
        '信じてみます。',
        '前向きになれた。',
        'ありがとうございました。',
        '納得できました。',
        '心に響きました。',
        '勇気もらえた。',
        'スッキリした！',
        '救われました。',
        '希望が見えた。',
        '励まされた。',
        '背中押された。',
        '安心できた。',
        '決断できそう。',
        '良かったです。',
        '満足です。',
        '嬉しいです。',
        '元気出た！',
        '参考になった。',
        '試してみる。',
        '信じます！',
        '頑張ろう。',
        'よかった。',
        '当たってる。',
        'なるほど。',
        '腑に落ちた。',
        'びっくり。',
        'そうかも。',
        '感動した。',
        '泣きそう。',
        '嬉しい。',
        '助かった。',
        '楽になった。',
        'すっきり。',
        'ほっとした。',
        '納得。',
        'その通り。',
        '的確。',
        'リピします。',
        '当たってた。',
        'また占う。',
        'いい感じ。',
        '最高。',
        'ピッタリ。',
        '鋭い。',
        '見透かされてる。',
        '神がかってる。',
        '信頼できる。',
    ]

    # カテゴリーに応じてコメントプールを作成
    try:
        if pd.notna(category):
            cat = int(float(category))
            if cat in [1, 2, 3, 9]:  # 恋愛系
                pool = love_comments + general_long_comments + general_short_comments
            elif cat == 8:  # 仕事系
                pool = work_comments + general_long_comments + general_short_comments
            elif cat == 7:  # 金運・人間関係系
                pool = money_relationship_comments + general_long_comments + general_short_comments
            else:
                pool = general_long_comments + general_short_comments
        else:
            pool = general_long_comments + general_short_comments
    except:
        pool = general_long_comments + general_short_comments

    return random.choice(pool)

# 日付生成
def random_date():
    start_date = datetime(2023, 10, 1)
    end_date = datetime(2023, 12, 31)
    delta = end_date - start_date
    random_days = random.randint(0, delta.days)
    return (start_date + timedelta(days=random_days)).strftime('%Y-%m-%d 00:00:00')

# 使用済みコメントを追跡（重複を最小限に）
used_comments = {}

def get_unique_comment(category):
    """できるだけ重複しないコメントを取得"""
    max_attempts = 100
    for _ in range(max_attempts):
        comment = generate_comment(category)
        # このコメントの使用回数をチェック
        if comment not in used_comments:
            used_comments[comment] = 1
            return comment
        elif used_comments[comment] < 2:  # 最大2回まで許容（3回→2回に変更）
            used_comments[comment] += 1
            return comment
    # それでも見つからない場合は最後の手段
    comment = generate_comment(category)
    used_comments[comment] = used_comments.get(comment, 0) + 1
    return comment

# SQLファイルの生成
output_lines = []
output_lines.append("INSERT INTO flowt_seimei.mana_comment (contents_id,title,comment,score,approval,`date`) VALUES")

records = []
for idx, row in df_contents.iterrows():
    contents_id = int(row['contents_id'])
    category = row['category']

    # 各contents_idに1~2件のコメントを生成
    num_comments = random.randint(1, 2)
    for _ in range(num_comments):
        comment = get_unique_comment(category)
        score = random.randint(3, 5)
        date = random_date()
        records.append(f"\t ({contents_id},NULL,'{comment}',{score},1,'{date}')")

# 10件ごとにINSERT文を分割
chunk_size = 10
for i in range(0, len(records), chunk_size):
    chunk = records[i:i+chunk_size]
    if i > 0:
        output_lines.append("INSERT INTO flowt_seimei.mana_comment (contents_id,title,comment,score,approval,`date`) VALUES")
    for j, record in enumerate(chunk):
        if j < len(chunk) - 1:
            output_lines.append(record[:-1] + ',')
        else:
            output_lines.append(record + ';')

# ファイル保存
timestamp = datetime.now().strftime('%Y%m%d%H%M')
filename = f'mana_comment_{timestamp}.sql'
with open(filename, 'w', encoding='utf-8') as f:
    f.write('\n'.join(output_lines))

# 重複統計
max_usage = max(used_comments.values()) if used_comments else 0
duplicates = sum(1 for v in used_comments.values() if v > 1)

print(f'生成完了: {filename}')
print(f'メニュー数: {len(df_contents)}')
print(f'コメント数: {len(records)}')
print(f'ユニークコメント数: {len(used_comments)}')
print(f'重複コメント数: {duplicates}')
print(f'最大使用回数: {max_usage}回')
