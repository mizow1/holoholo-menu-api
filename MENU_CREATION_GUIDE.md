# ホロホロタロット メニュー作成ガイドライン

## 概要
このガイドは、ホロホロタロットの新しい占いメニューを作成する際の注意点と手順をまとめたものです。

---

## 📁 ファイル構造

### 主要ファイル
- **ホロホロタロット追加メニュー.xlsx** - メニューデータベース本体
  - メニューシート: 占いメニューの基本情報
  - 小項目シート: 各メニューの質問項目
  - 結果シート: タロット占い結果テキスト
- **card_name.csv** - タロットカードマスタデータ（44枚）

---

## 🎴 カード情報の確認（最重要）

### card_name.csvの構造
| カードID | 名称 | 読み | キーワード | 概要 | detail |
|---------|------|------|-----------|------|--------|
| 1 | I'O | イオ | ミステリー | 全ては必然で起こっている | （詳細説明） |
| 14 | ALOHA | アロハ | 愛 | 真の愛を学ぶ | （詳細説明） |
| ... | ... | ... | ... | ... | ... |

### ⚠️ 重要な注意点
1. **カード番号 = カードID**
   - 結果シートの「カード番号」列には、必ず`card_name.csv`の「カードID」を使用すること
   - 例: カード14は「ALOHA（アロハ）- 愛」

2. **鑑定文はカードの意味に沿って作成**
   - カードの「キーワード」と「概要」を必ず参照
   - カードの本質的な意味から外れないこと
   - 例: ALOHAカード（愛）を使う場合、エゴや依存のない真の愛について言及する

3. **カード選定のコツ**
   - メニューのテーマに合ったカードを選ぶ
   - 恋愛系: ALOHA(14), TAPA(3), POHAKU(36), HO'OPONOPONO(24), LAKA(23)など
   - 仕事系: MANO(9), LONO(8), KANE(40), PUA(34)など
   - 人生系: I'O(1), HUNA(7), PUEO(18), ANUENUE(42)など

4. **🚨 結果パターン内でのカード重複禁止（最重要）**
   - **同じ結果パターンでは、異なるカードを使用すること**
   - 結果パターン = 各小項目の何番目の結果か（result_idの下2桁）
   - 同じパターンの結果は同時に表示されるため、カードが重複すると不自然

#### 結果パターンとは？

result_idの構造: `{contents_id}{menu_id:02d}{結果パターン:02d}`

例: メニューID 1067、小項目4つ、各小項目に4つの結果がある場合
```
小項目01の結果01: 10670101 ← パターン01
小項目01の結果02: 10670102 ← パターン02
小項目01の結果03: 10670103 ← パターン03
小項目01の結果04: 10670104 ← パターン04

小項目02の結果01: 10670201 ← パターン01
小項目02の結果02: 10670202 ← パターン02
小項目02の結果03: 10670203 ← パターン03
小項目02の結果04: 10670204 ← パターン04

...
```

#### ✅ 良い例（OK）

**例1: 同じ結果パターンで全て違うカード**
```
パターン01の構成:
10670101: HUNA (小項目01のパターン01)
10670201: PUEO (小項目02のパターン01)
10670301: KANE (小項目03のパターン01)
10670401: LAKA (小項目04のパターン01)
→ 全て異なるカードなのでOK
```

**例2: 同じカードでも結果パターンが違う**
```
10670101: HUNA (パターン01)
10670102: PUEO (パターン02)
10670103: HUNA (パターン03) ← HUNAが再登場
10670104: PUEO (パターン04) ← PUEOが再登場
→ パターンが違うので同時に表示されない。OK
```

#### ❌ 悪い例（NG）

**例3: 同じ結果パターンで同じカードが重複**
```
パターン01の構成:
10670101: HUNA (小項目01のパターン01)
10670201: PUEO (小項目02のパターン01)
10670301: HUNA (小項目03のパターン01) ← HUNAが重複！
10670401: LAKA (小項目04のパターン01)
→ パターン01でHUNAが2回出現。NG！
```

#### チェック方法

各結果パターンごとに、使用しているカードをリストアップ:
```
パターン01: [HUNA, PUEO, KANE, LAKA] → 重複なしOK
パターン02: [ALOHA, MANA, TAPA, PELE] → 重複なしOK
パターン03: [POHAKU, HUNA, PUEO, NALU] → 重複なしOK
パターン04: [KANALOA, ANUENUE, LEI, HUNA] → 重複なしOK
```

---

## 📊 データベース構造

### 3層構造
```
メニュー (1)
  └── 小項目 (N)
        └── 結果 (N × カード枚数)
```

### 例: メニューID 301「あなたの結婚運鑑定」
- メニュー: 1件
- 小項目: 3件
  - 項目1: 運命の結婚相手の一目でわかる特徴は？
  - 項目2: その運命の人の内面はどんな感じ？
  - 項目3: 幸せな結婚をするためにあなたに必要なこと
- 結果: 12件 (3項目 × 4カード)

---

## 🆔 ID命名規則

### メニューID（contents_id）
- 連番で割り当て
- 現在の最大値を確認してから+1
- 例: 最大が1067なら、次は1068

### 項目ID（menu_id）
- フォーマット: `{メニューID}{項目番号:02d}`
- 例: メニュー1068の項目1 → 106801

### 結果ID（result_id）
- フォーマット: `{メニューID}{項目番号:02d}{結果番号:02d}`
- 例: メニュー1068、項目1、結果1 → 10680101

### 公開日（start_date）
- **基準日**: contents_id=1042のstart_dateは2026/01/01 0:00
- **計算方法**: contents_idが1増えるごとに1日追加
- **例**:
  - contents_id=1042 → 2026-01-01 00:00:00
  - contents_id=1043 → 2026-01-02 00:00:00
  - contents_id=1044 → 2026-01-03 00:00:00
  - contents_id=1068 → 2026-01-27 00:00:00（1042 + 26日）

### カテゴリーID（category_id）
- **参照ファイル**: `category_id.csv`を必ず確認すること
- **割り当て方法**: メニュー内容に最も適したカテゴリーのcategory_idを選択
- カテゴリーの詳細は下記「📋 カテゴリー一覧」セクションを参照

---

## 📝 メニュー作成手順

### STEP 1: 企画
1. メニューのジャンル選定（恋愛/仕事/金運/人生など）
2. **メニュー名とキャプション決定**
   - **メニュー名は疑問形で、ユーザーの興味を引き付けるものにする（重要）**
   - ❌ 悪い例: 「あなたのキャリアの可能性と成功の道筋」（機械的で退屈）
   - ✅ 良い例: 「今の評価は？　チャンスは？　仕事で成功を掴む方法」（具体的で興味を引く）
   - ❌ 悪い例: 「別れたあの人との復縁の可能性」（淡白）
   - ✅ 良い例: 「あの人は今でも私のこと覚えてる？　復縁の可能性は？」（感情に訴える）
   - キャッチコピー（catch）も同様に、ユーザーの悩みや疑問に直接訴えかける表現を使う
3. 小項目（質問）の数を決定（通常3〜5項目）
4. 各小項目の質問内容を決定

### STEP 2: カード選定
1. `card_name.csv`を開いて全カードを確認
2. メニューテーマに合ったカードを選定
3. 各小項目に4枚程度のカードを割り当て
   - 既存メニューのパターンを参考にする

```python
# カード確認用コード
import pandas as pd
card_df = pd.read_csv('card_name.csv', encoding='shift-jis')
print(card_df[['カードID', '名称', '読み', 'キーワード']])
```

### STEP 3: 鑑定文作成
1. 選定したカードごとに鑑定文を作成
2. **必須要素:**
   - カード名の明記: 「【カード名】のカードが出ました」
   - カードの概要引用: card_name.csvの「概要」列を参照
   - 具体的な鑑定内容
3. **文字数: 300文字を目安に作成（重要）**
   - 最低でも250文字以上、理想は300〜350文字
   - 簡潔すぎる鑑定文（150文字以下）はユーザーの満足度を下げる
   - カードの意味を丁寧に説明し、ユーザーの状況に寄り添う内容にする
   - ハワイアンタロットの神話や伝説を織り交ぜることで、深みと説得力が増す

#### ⚠️ カード概要の自然な組み込み方（重要）

カード概要は**必ず自然な日本語として組み込むこと**。単純に並べるだけでは不自然な文章になります。

**❌ 悪い例（不自然）:**
```
【ALOHA】のカードが出ました。真の愛を学ぶ 今のあの人の気持ちに関して…
→ 「真の愛を学ぶ」が唐突に挿入され、前後とのつながりがない
```

**✅ 良い例（自然）:**
```
パターン1: 「このカードは『○○』を意味します」形式
【ALOHA】のカードが出ました。このカードは「真の愛を学ぶ」を意味します。今のあの人の気持ちについて…

パターン2: 「カードのテーマは『○○』です」形式
【ALOHA】のカードが出ました。カードのテーマは「真の愛を学ぶ」です。今のあの人の気持ちについて…

パターン3: 「○○ことを示す重要なカードです」形式
出たカードは【ALOHA】。真の愛を学ぶことを示す重要なカードです。今のあの人の気持ちについて…

パターン4: 「○○を象徴し、○○ことを教えてくれます」形式
【ALOHA】のカードが出ました。ALOHAは愛を象徴し、真の愛を学ぶことを教えてくれます。今のあの人の気持ちについて…

パターン5: 「『○○』というメッセージが込められています」形式
【ALOHA】のカードが示されました。「真の愛を学ぶ」というメッセージが込められています。今のあの人の気持ちについて…
```

#### 💡 鑑定文作成のコツ

1. **バリエーションを持たせる**
   - 同じパターンの繰り返しは機械的に見える
   - 項目ごとに異なる表現を使う
   - カード紹介部分と本文部分の組み合わせを変える

2. **項目の内容に応じた表現を選ぶ**
   - 「気持ち」系: 「○○のエネルギーが強く働いています」「○○という気持ちが芽生えています」
   - 「相性・関係」系: 「○○が重要な鍵となります」「○○を意識することで関係はさらに…」
   - 「未来」系: 「○○に関わる出来事が待っています」「カードは○○の訪れを告げています」
   - 「アドバイス」系: 「○○を意識することが大切です」「○○を心がけることで…」

3. **一文ずつ確認する**
   - 主語と述語が対応しているか
   - 修飾語が正しい位置にあるか
   - 読み上げて違和感がないか

**鑑定文テンプレート（改善版）:**
```
【カード紹介部分】（5パターンから選択）
+ 【本文部分】（項目の種類に応じた表現）
+ 【締めくくり部分】（アドバイスや展開）
```

### STEP 4: データ投入
1. メニューシートに1行追加
   - メニューID（contents_id）: 現在の最大値+1
   - メニュー名、キャプション
   - **カテゴリー（category_id）**: `category_id.csv`を参照し、メニュー内容に合ったカテゴリーを選択
   - **公開日（start_date）**: contents_id=1042を基準（2026/01/01）として、contents_idが1増えるごとに1日追加
     - 例: contents_id=1068の場合 → 2026/01/27（1042から26日後）
2. 小項目シートに項目数分追加
   - メニューID、項目ID、項目名
3. 結果シートに結果を追加
   - メニューID、項目ID、結果ID、**カード番号（重要！）**、結果本文

### STEP 5: SQLファイル作成
1. ファイル作成
   - ファイル名: `menu_{メニューID}.sql`
   - 例: メニューID 1043の場合 → `menu_1043.sql`

2. SQLファイルの構造
   ```sql
   -- ========================================
   -- 占いメニュー: {メニュー名}
   -- Contents ID: {メニューID}
   -- 作成日: YYYY-MM-DD
   -- ========================================

   -- 1. mana_contentsテーブルに追加
   -- category: category_id.csvを参照し、メニュー内容に合ったカテゴリーを選択
   -- start_date: contents_id=1042を基準（2026-01-01）として、contents_idが1増えるごとに1日追加
   --   例: contents_id=1068の場合 → '2026-01-27 00:00:00'（1042から26日後）
   INSERT INTO flowt_seimei.mana_contents (contents_id, name, catch, caption, category, tag_1, tag_2, tag_3, tag_4, tag_5, start_date) VALUES
   ({メニューID}, '{メニュー名}', '{キャッチコピー}', '{キャプション}', {カテゴリーID}, NULL, NULL, NULL, NULL, NULL, '{公開日}');

   -- 2. mana_menuテーブルに追加
   INSERT INTO flowt_seimei.mana_menu (contents_id, menu_id, name) VALUES
   ({メニューID}, {項目ID1}, '{項目名1}'),
   ({メニューID}, {項目ID2}, '{項目名2}'),
   ({メニューID}, {項目ID3}, '{項目名3}');

   -- 3. mana_resultテーブルに追加
   INSERT INTO flowt_seimei.mana_result (contents_id, menu_id, result_id, body) VALUES
   ({メニューID}, {項目ID1}, {結果ID1}, '{鑑定文1}'),
   ({メニューID}, {項目ID1}, {結果ID2}, '{鑑定文2}'),
   ...;

   -- 4. mana_cardテーブルに追加
   INSERT INTO flowt_seimei.mana_card (contents_id, menu_id, result_id, body) VALUES
   ({メニューID}, {項目ID1}, {結果ID1}, {カードID1}),
   ({メニューID}, {項目ID1}, {結果ID2}, {カードID2}),
   ...;

   -- ========================================
   -- インポート完了
   -- ========================================
   -- 確認クエリ:
   -- SELECT * FROM mana_contents WHERE contents_id = {メニューID};
   -- SELECT * FROM mana_menu WHERE contents_id = {メニューID};
   -- SELECT * FROM mana_result WHERE contents_id = {メニューID};
   -- SELECT * FROM mana_card WHERE contents_id = {メニューID};
   ```

3. 重要な注意点
   - SQLの文字列内にシングルクォート（'）が含まれる場合は、2つ重ねる（''）
   - 例: `WA'A` → `WA''A`、`LONO/KAMAPUA'A` → `LONO/KAMAPUA''A`
   - 鑑定文内の改行は削除し、1行で記述する
   - 各INSERT文は項目数に応じて行数が変わる

4. データの対応関係
   | Excel シート | SQLテーブル | 主なカラム |
   |-------------|------------|-----------|
   | メニュー | mana_contents | contents_id, name, catch, caption, category, start_date |
   | 小項目 | mana_menu | contents_id, menu_id, name |
   | 結果 | mana_result | contents_id, menu_id, result_id, body |
   | （結果） | mana_card | contents_id, menu_id, result_id, body（カードID） |

5. 確認手順
   - SQLファイルを作成したら、必ず末尾の確認クエリを実行
   - データが正しく投入されているか確認
   - カード番号が正しくmana_cardテーブルに登録されているか確認

---

## ✅ 作成後のチェックリスト

### Excelデータ
- [ ] カード番号がcard_name.csvのカードIDと一致している
- [ ] 各カードの意味（キーワード、概要）と鑑定文の内容が整合している
- [ ] 鑑定文にカード名が明記されている
- [ ] **【重要】カード概要が自然な日本語として組み込まれている（唐突に挿入されていない）**
- [ ] **【重要】鑑定文を声に出して読んで、違和感がない**
- [ ] **【重要】同じパターンの機械的な繰り返しになっていない（バリエーションがある）**
- [ ] **🚨【最重要】同じ結果パターン内でカードが重複していない**
  - パターン01: 全小項目で異なるカードを使用
  - パターン02: 全小項目で異なるカードを使用
  - パターン03: 全小項目で異なるカードを使用
  - パターン04: 全小項目で異なるカードを使用
- [ ] メニューID、項目ID、結果IDの命名規則が正しい
- [ ] 小項目の質問が明確で分かりやすい
- [ ] 各項目に適切な数のカードが割り当てられている（通常4枚程度）
- [ ] メニュー、小項目、結果の件数が整合している

### SQLファイル
- [ ] ファイル名が`menu_{メニューID}.sql`形式になっている
- [ ] 4つのテーブル（mana_contents, mana_menu, mana_result, mana_card）すべてにINSERT文がある
- [ ] シングルクォートのエスケープ処理が正しく行われている（' → ''）
- [ ] 鑑定文の改行が削除されている
- [ ] カードIDがmana_cardテーブルに正しく登録されている
- [ ] 確認クエリが記載されている

### 🚨 重複チェック（自動生成時は必須）
- [ ] **`python check_duplicates.py`を実行して重複なしを確認**
  - 特に大量生成時（50件以上）は必ず実行
  - タイトル重複はSEOスパムと判定されるリスクあり
  - 重複が見つかった場合は該当メニューを再生成

---

## 🛠️ 便利なスクリプト

### 既存データのパターン確認
```python
# check_card_usage.py を実行
python check_card_usage.py
```

### カード情報の検索
```python
import pandas as pd
card_df = pd.read_csv('card_name.csv', encoding='shift-jis')

# キーワードで検索
keyword = '愛'
result = card_df[card_df['キーワード'].str.contains(keyword, na=False)]
print(result[['カードID', '名称', 'キーワード']])
```

---

## 📋 カテゴリー一覧

**参照**: `category_id.csv`を必ず確認すること

| カテゴリーID | カテゴリー名 |
|------------|------------|
| 1 | 両思い |
| 2 | 片思い |
| 3 | 相手の気持ち |
| 4 | 不倫 |
| 5 | 夜の相性 |
| 6 | 結婚 |
| 7 | 人生 |
| 8 | 仕事 |
| 9 | 復縁 |
| 10 | 出会い |

---

## 🎯 良い例・悪い例

### ❌ 悪い例1: カードの意味と無関係
```
カード番号: 1
鑑定文: 「あの人はあなたに対してキラキラした瞳で見つめています...」
→ カード1（I'O - ミステリー）の意味と無関係な内容
```

### ❌ 悪い例2: カード概要が唐突に挿入される（最も多いエラー）
```
カード番号: 14
鑑定文: 「【ALOHA】のカードが出ました。真の愛を学ぶ 今のあの人の気持ちに関して、
愛のエネルギーが強く影響しています...」
→ 「真の愛を学ぶ」だけが前後とのつながりがなく、不自然な日本語になっている
→ カード概要をそのまま挿入しただけで、文章として成立していない
```

### ❌ 悪い例3: 同じパターンの機械的な繰り返し
```
鑑定文1: 「【ALOHA】のカードが出ました。このカードは「真の愛を学ぶ」を意味します...」
鑑定文2: 「【MANA】のカードが出ました。このカードは「力を与えること」を意味します...」
鑑定文3: 「【KANE】のカードが出ました。このカードは「もう一度始める」を意味します...」
→ すべて同じパターンで機械的。バリエーションが必要
```

### ✅ 良い例1: カードの意味に沿った内容
```
カード番号: 14
鑑定文: 「【ALOHA】のカードが出ました。アロハという言葉は簡単に使われていますが、
実はとても深い意味を持つ言葉です。今、あの人はあなたに対して純粋な好意を抱いています。
それはエゴや依存のない、誠実な愛情です...」
→ カード14（ALOHA - 愛）の本質的な意味に沿った内容
```

### ✅ 良い例2: 自然な日本語でカード概要を組み込む
```
カード番号: 14
パターン1: 「【ALOHA】のカードが出ました。このカードは「真の愛を学ぶ」を意味します。
今のあの人の気持ちについて、愛のエネルギーが強く働いています...」

パターン2: 「出たカードは【ALOHA】。真の愛を学ぶことを示す重要なカードです。
今のあの人の気持ちについて、愛のエネルギーが強く働いています...」

パターン3: 「【ALOHA】のカードが出ました。ALOHAは愛を象徴し、真の愛を学ぶことを教えてくれます。
今のあの人の気持ちについて、愛のエネルギーが強く働いています...」

→ どのパターンも文章として自然で、カード概要が適切に組み込まれている
```

### ✅ 良い例3: バリエーションを持たせた鑑定文
```
鑑定文1: 「【ALOHA】のカードが出ました。このカードは「真の愛を学ぶ」を意味します...」
鑑定文2: 「出たカードは【MANA】。満ちているエネルギーをどう使うかを示す重要なカードです...」
鑑定文3: 「【KANE】のカードが示されました。「もう一度始める」というメッセージが込められています...」
→ それぞれ異なるパターンを使用し、自然で読みやすい
```

---

## 📞 トラブルシューティング

### Q1: どのカードを選べばいいか分からない
**A:** 既存の似たジャンルのメニューを参考にする
```python
# 既存メニューのカード使用例を確認
python check_card_usage.py
```

### Q2: カード番号がおかしいと言われた
**A:** card_name.csvを開いて、カードIDを確認する（1〜44の範囲内）

### Q3: 鑑定文が書けない
**A:** card_name.csvの「detail」列を読んで、カードの深い意味を理解する

### Q4: 鑑定文の日本語が不自然になってしまう
**A:** カード概要をそのまま挿入せず、以下のパターンで自然に組み込む

**問題のある例:**
```
【ALOHA】のカードが出ました。真の愛を学ぶ 今のあの人の気持ちに関して…
→ 「真の愛を学ぶ」が唐突で前後とつながらない
```

**改善方法:**
```
パターン1: このカードは「○○」を意味します
パターン2: カードのテーマは「○○」です
パターン3: ○○ことを示す重要なカードです
パターン4: ○○を象徴し、○○ことを教えてくれます
パターン5: 「○○」というメッセージが込められています
```

**確認方法:**
1. 声に出して読んでみる
2. 一文ずつ主語と述語の対応を確認
3. STEP 3の「カード概要の自然な組み込み方」セクションを参照

### Q5: 自動生成したメニューでタイトルが重複してしまった
**A:** シード生成ロジックの問題です。以下を確認してください

**🚨 重要: タイトル重複はSEOスパムと判定されるリスクがあります**

**問題の原因:**
- 単純な `random.seed(contents_id)` だけでは、異なるcontents_idでも偶然同じランダム値が生成される可能性がある
- 特に大量のメニュー生成時（100件以上）に重複が発生しやすい

**解決方法: get_seed_value()関数を使用**

`generate_truly_unique_menus.py` に実装されている正しいシード生成方法:

```python
def get_seed_value(contents_id, function_type):
    """contents_idから関数タイプ別のユニークなシード値を生成

    大きな素数を使ってシードの分散を改善し、
    異なる関数で同じシード値にならないようにする
    """
    prime = 7919  # 大きな素数
    offset_map = {
        'cards': 0,
        'title': 1,      # タイトル生成用
        'catch': 2,      # キャッチコピー生成用
        'caption': 3,    # キャプション生成用
        'components': 4,
        'items': 5       # 小項目生成用
    }
    offset = offset_map.get(function_type, 0)
    return contents_id * prime + offset * 97
```

**使用例:**
```python
# ❌ 悪い例: 衝突の可能性あり
def generate_unique_menu_name(contents_id, category_id):
    random.seed(contents_id)  # これだけでは不十分
    # ...

# ✅ 良い例: 関数別に異なるシード値
def generate_unique_menu_name(contents_id, category_id):
    random.seed(get_seed_value(contents_id, 'title'))  # 正しい
    # ...

def generate_unique_catch(contents_id, category_id):
    random.seed(get_seed_value(contents_id, 'catch'))  # 正しい
    # ...
```

**重複チェックの必須化:**
```bash
# メニュー生成後は必ずチェックを実行
python check_duplicates.py
```

**チェック結果の見方:**
```
[OK] 重複なし！全メニューがユニークです。
→ 問題なし

[警告] 重複したメニューが見つかりました！
→ 該当メニューを再生成する必要あり
```

**再発防止のポイント:**
1. **必ず `get_seed_value()` を使用する** - 単純な `contents_id` だけでシードを生成しない
2. **関数タイプ別にシードを分ける** - タイトル、キャッチ、キャプション、小項目でそれぞれ異なるシード
3. **生成後は必ず重複チェック** - 特に50件以上の大量生成時は必須
4. **素数を使用する** - 7919など大きな素数を使うことで分散を改善

---

## 📚 参考資料

- `card_name.csv` - カードマスタデータ
- `check_card_usage.py` - カード使用パターン確認ツール
- `fix_menu_1068.py` - メニュー1068の修正例（参考コード）
- `menu_1043.sql` - SQLファイル作成の参考例

---

**最終更新: 2025-11-13**
